 <script type="text/javascript" src="jquery-2.1.4.js"></script>
 <script type="text/javascript" src="/socket.io/socket.io.js"></script>
     <script type="text/javascript" src="howler.js"></script>
 <!DOCTYPE html>
<html>


<style>


@font-face {
    font-family: "Press Start 2P";
    src: url('PressStart2P.ttf') format('truetype');
}



body{background-color:#000000; font-family:"Press Start 2P"; font-size:2vw; color:#FFFFFF}

  .pbcontainer {
      background-color: white;
      padding: 5px;
      height: 405px;
      width:110px;
    }


  .progressbar {
      background-color: black;
      padding: 0px;
      height: 100%;
      width:100%;
    }
    
   .colorbar{
        width: 100%;
       height: 0%;
       padding:0px;
       position: relative;
       top: 100%;

    }


 
 </style>




<body>

<div id="header">&nbsp;</div>


<div style="position: absolute; left:10%;">
    <div class="pbcontainer">
     <div class="progressbar"><div class="colorbar" id="bar0" style="background-color: #FF5555;"></div></div>
    </div>
<span id="button0">B</span>

</div>



<div style="position: absolute; left:35%;">
<div class="pbcontainer">
 <div class="progressbar"><div class="colorbar" id="bar1" style="background-color: #55FF55;"></div></div>
</div>

<span id="button1">B</span>
</div>


<div style="position: absolute; left:60%;">
<div class="pbcontainer">
 <div class="progressbar"><div class="colorbar" id="bar2" style="background-color: #00AAAA;"></div></div>
</div>

<span id="button2">B</span>
</div>




</body>




</html>

<script>
var socket = io('/display');
var danceScore=0;
var manifest;
var vocals=[];
var drums=[];
var bass=[];
var sink=[];
var oggHTTPserver='http://localhost:8080/';
var foundVocal=false;
var foundSong=false;
var titleLoop;

var startVol=0;
var maxVol=0.75;

var loadRandomSong= function(){

 vocals=[];
 drums=[]; 
 bass=[];  
 sink=[];  
 foundVocal=false;
 foundSong=false;

 
 var iType;
 var s=Math.floor(Math.random() * manifest.length);
 
 
 console.log("Found:   " + manifest[s].name);
 
 $("#header").html(manifest[s].name);
  for (t in manifest[s].children){  //once through to see if "vocal" and "song" are different.
     
     if (manifest[s].children[t].name.match(/vocal/i)){//found "vocal.ogg"
        foundVocal=true;
     }
    if (manifest[s].children[t].name.match(/song/i)){//found "song.ogg"
        foundSong=true;
     }
 }   

loadSongTracks(s,0); //start with track 0
 
 
    
}



var loadSongTracks = function(s,t){
console.log ("waiting 2 seconds")
setTimeout(function(){immediatelyLoadSongTracks(s,t)},2000);
    
}


var immediatelyLoadSongTracks = function(s,t){//now, actually load the files
var vocalsLoaded=false;
    
    if (manifest[s].children[t]){//make sure the entry exists.
     
     
     var trackToLoad=oggHTTPserver + manifest[s].children[t].path;      
     //console.log("let's try: " + trackToLoad);
     
     if (manifest[s].children[t].name.match(/bass/i) || manifest[s].children[t].name.match(/rhythm/i) ){//bass
        
      iType="bass";
      bass.push ( new Howl({
                  urls: [trackToLoad],
                  autoplay: false,
                  loop: false,
                  volume: startVol,
                  onload: function() {
                    loadSongTracks(s,t+1);
                  }}));
  
  
  //   }else if (manifest[s].children[t].name.match(/guitar/i) || manifest[s].children[t].name.match(/keys/i) || manifest[s].children[t].name.match(/piano/i) ){//guitars or keys
  //      iType="keysguitar";
     }else if (manifest[s].children[t].name.match(/vocal/i)){//vocal
          iType="vocal";
          
               if (!vocalsLoaded){//don't double-fire the next song
                   vocals.push ( new Howl({
                          urls: [trackToLoad],
                          autoplay: false,
                          loop: false,
                          volume: maxVol,
                          onload: function() {
                            loadSongTracks(s,t+1);
                          },
                          onend: function(){location.reload();}
    
                          }));
                   vocalsLoaded=true;
               }else{           
                
                                   vocals.push ( new Howl({
                          urls: [trackToLoad],
                          autoplay: false,
                          loop: false,
                          volume: maxVol,
                          onload: function() {
                            loadSongTracks(s,t+1);
                          }
                          }));
                }
                




     }else if (manifest[s].children[t].name.match(/song/i)){//sink
            if (foundVocal && foundSong){
                iType="sink";
                sink.push ( new Howl({
                              urls: [trackToLoad],
                              autoplay: false,
                              loop: false,
                              volume: startVol,
                              onload: function() {
                                loadSongTracks(s,t+1);
                              }}));


            }else{
               iType="vocal";    

               if (!vocalsLoaded){//don't double-fire the next song
                   vocals.push ( new Howl({
                          urls: [trackToLoad],
                          autoplay: false,
                          loop: false,
                          volume: maxVol,
                          onload: function() {
                            loadSongTracks(s,t+1);
                          },
                          onend: function(){location.reload();}
    
                          }));
                          vocalsLoaded=true;
               }else{           
                
                                   vocals.push ( new Howl({
                          urls: [trackToLoad],
                          autoplay: false,
                          loop: false,
                          volume: maxVol,
                          onload: function() {
                            loadSongTracks(s,t+1);
                          }
                          }));
                }
                
                
                
               
               
               
            }    
     }else if (manifest[s].children[t].name.match(/drum/i)){//drums
        iType="drum";
          drums.push ( new Howl({
                      urls: [trackToLoad],
                      autoplay: false,
                      loop: false,
                      volume: startVol,
                      onload: function() {
                        loadSongTracks(s,t+1);
                      }}));
        
        
     }else{ //everything else (player 3)
        iType="sink";
                  sink.push ( new Howl({
                      urls: [trackToLoad],
                      autoplay: false,
                      loop: false,
                      volume: startVol,
                      onload: function() {
                        loadSongTracks(s,t+1);
                      }}));

     }
     
     console.log("Loading: " + manifest[s].children[t].path  + " (" + iType +   ") " + (t +1) , "of "  + manifest[s].children.length);
     
     
 }else{
    
    console.log("All Tracks loaded. Playing.");
    
    titleLoop.fade(titleLoop.volume(), 0,5000, function(){titleLoop.stop();})
    
    play();
    }
 
}  //end load songs function


function setTrackVol(instrument,vol){
if (instrument===0){
    drums.forEach(function(whichTrack){
       //console.log(whichTrack);
       whichTrack.volume(vol);
    });
}

if (instrument===1){
    bass.forEach(function(whichTrack){
       whichTrack.volume(vol);
    });
}

if (instrument===2){
    sink.forEach(function(whichTrack){
       whichTrack.volume(vol);
    });
}





}





var play = function() {
    vocals.forEach(function(whichTrack){
       whichTrack.play();
    });
    drums.forEach(function(whichTrack){
       whichTrack.play();
    });
    bass.forEach(function(whichTrack){
       whichTrack.play();
    });
    sink.forEach(function(whichTrack){
       whichTrack.play();
    });
};




















$( document ).ready(function() {
    console.log( "ready!" );










    $.ajax({
      dataType:'json',
      type: 'GET',
      url: oggHTTPserver + "manifest.JSON",
      success: function(data, textStatus, jqXHR) {
        // `data` contains parsed JSON
        manifest=data.children;
        console.log(manifest.length + " songs available");
        setTimeout(function(){loadRandomSong();},20000) //enough time to allow memory to be reclaimed
        setTimeout(function(){
        titleLoop = new Howl({
            urls: ['BitQuestLoop.ogg'],
            autoplay: true,
            loop: true,
            volume: maxVol
            }
        );
            },5000) //enough time to allow memory to be reclaimed




        ding = new Howl({
            urls: ['ding.ogg'],
            autoplay: true,
            loop: false,
            volume: maxVol
            }
        );

        





        
        
      },
      error: function(jqXHR, textStatus, errorThrown) {
         console.log("COULD NOT LOAD MANIFEST!");
      }
      
      
    });




}); //end document ready

socket.on('clientUpdate', function(data) { //client dancability info
	var gradient=0;
	//console.log(data);
    if (data.buttonPushed){
        $( "#button"+data.slot).css("background-color", "red");
    }else{
        $( "#button"+data.slot).css("background-color", "pink");
    }
    if (data.danceScore<danceScore){ gradient=250}else{gradient=0}
    
    //console.log(data.slot);
    if (data.slot<3){
        if (data.buttonPushed){
            setTrackVol(data.slot, data.danceScore/70)
        }else{
            setTrackVol(data.slot,0)            
        }   
        
    }
    
     
     var myScore = (data.danceScore * 1.5);
     if (myScore>100){myScore=100}
     $( "#bar" +data.slot).css("height", myScore + "%");
     $( "#bar" +data.slot).css("top",  100-myScore + "%");        
      
     
     
      danceScore =data.danceScore;
    
	
	
});




</script>