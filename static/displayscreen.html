 <script type="text/javascript" src="jquery-2.1.4.js"></script>
 <script type="text/javascript" src="/socket.io/socket.io.js"></script>
     <script type="text/javascript" src="howler.js"></script>
 <!DOCTYPE html>
<html>


<style>


@font-face {
    font-family: "Press Start 2P";
    src: url('PressStart2P.ttf') format('truetype');
}



body{background-color:#000000; font-family:"Press Start 2P"; font-size:1.5vw; color:#FFFFFF}


#instrument{
      height: 11.55vh;
      margin:auto; 
      margin-top:0.5vh;
} 


#songtitle{
    position:absolute;
    top:94vh;
    left:1.5vw;
}


#songprogress{
    position:absolute;
    width:57.5vw;
    height:3.5vh;
    border: 0.2em solid #FFFFFF;
    background-color:grey;
    padding: 0px;
    top:87vh;
    left:1.5vw;
}

   #progresscolor{
       background-color:#FF5555;
       width: 50%;
       height: 100%;
       padding:0px;
       position: relative;
       left: 0%;

    }










.centeredDiv{
  position:absolute;
  color:#fff;
  width:90%;
  top:50%;
  left:50%;
  /*background-color:red; */
  padding:0.6em;
  transform: translate(-50%,-50%);
   text-align: center;
} 



  #thegame{
    display:none
    }

#titlescreen{
    display:none
    }




.roundedbox{
    position: absolute; 
    text-align:center; 
    border-radius: 2em;
    border: 0.2em solid #FFFFFF;
    padding:0.8em; 
    width: 15vw;
    top:2.6vh;
    height: 62vh; 
    background-color:grey;
}




  .metercontainer {
    margin:auto; 
    margin-top:2.6vh;
      background-color: white;
      padding: 0.2em;
      height: 42vh;
      width:6vw;
    }


  .meterbar {
      background-color: black;
      padding: 0px;
      height: 100%;
      width:100%;
    }
    
   .metercolorbar{
        width: 100%;
       height: 0%;
       padding:0px;
       position: relative;
       top: 100%;

    }


.console{
    position: absolute; 
    text-align:center; 
    border-radius: 2em;
    border: 0.2em solid #FFFFFF;
    padding: 0.8em; 
    width: 15vw;
    height: 5.3vh;
    top:73vh; 
    background-color:grey;
}




 
 </style>




<body>

<div id="presents" class="centeredDiv">Karaoke Research Council Presents</div>

<img id="forkme" style="display:none; position: fixed; top: 0; right: 0; border: 0;" src="ForkMeOnGithub.png" >
<div id="titlescreen" class="centeredDiv">Karaoke Research Council Presents<br><br><br><br><img src="ns_logo.png" style="width:35%"><br><br><br><br><br><br><br><br><br><span style="color:grey;">connect to</span><br><br><br><span style="font-size:2vw">HTTP://NS.MOD.BZ </span><br><br><span style="color:grey;"><br>on your mobile browser to play. <br><br></span>
<div id="loadupdates">&nbsp;</div>
    </div>




<div id="thegame">



    
    <div id="box1" class="roundedbox" style="left:2.5%;">PLAYER 1
        <div class="metercontainer">
         <div class="meterbar"><div class="metercolorbar" id="bar0" style="background-color: #FF5555;"></div></div>
        </div>

    <div id="instrument"><img src="drums.png" style="height:100%"> </div>    
    </div>
    
    
    
    <div id="box2" class="roundedbox" style="left:22.5%;">PLAYER 2
    <div class="metercontainer">
     <div class="meterbar"><div class="metercolorbar" id="bar1" style="background-color: #55FF55;"></div></div>
    </div>

<div id="instrument"><img src="bass.png" style="height:100%"> </div>    

    </div>
    
    
    <div id="box3" class="roundedbox" style="left:42.5%;">PLAYER 3
    <div class="metercontainer">
     <div class="meterbar"><div class="metercolorbar" id="bar2" style="background-color: #00AAAA;"></div></div>
    </div>
    <div id="instrument"><img src="sink.png" style="height:100%"> </div>    

    </div>
    
    <div id="console1" class="console" style="left:2.5%;">VISIT URL TO PLAY!</div>
    <div id="console2" class="console" style="left:22.5%;">VISIT URL TO PLAY!</div>
    <div id="console3" class="console" style="left:42.5%;">VISIT URL TO PLAY!</div>
    
    
    <div id="songprogress"><div id="progresscolor"></div></div>
    
    
    <div id="songtitle">&nbsp;</div>


</div>



</body>




</html>

<script>
var debugMainScreen=true;


var socket = io('/display');
var danceScore=0;
var manifest;
var vocals=[];
var drums=[];
var bass=[];
var sink=[];
var oggHTTPserver='http://localhost:8080/';
var foundVocal=false;
var foundSong=false;
var titleLoop;

var startVol=0;
var maxVol=0.75;
var currentSong;

var loadRandomSong= function(){

 vocals=[];
 drums=[]; 
 bass=[];  
 sink=[];  
 foundVocal=false;
 foundSong=false;



 
 var iType;
 var s=Math.floor(Math.random() * manifest.length);

 
 
 
 console.log("Found:   " + manifest[s].name);
 
 currentSong=manifest[s].name;
 $("#loadupdates").html("LOADING: " + currentSong);
 

  for (t in manifest[s].children){  //once through to see if "vocal" and "song" are different.
     
     if (manifest[s].children[t].name.match(/vocal/i)){//found "vocal.ogg"
        foundVocal=true;
     }
    if (manifest[s].children[t].name.match(/song/i)){//found "song.ogg"
        foundSong=true;
     }
 }   

loadSongTracks(s,0); //start with track 0
 
 
    
}



var loadSongTracks = function(s,t){
console.log ("waiting 200 ms")
setTimeout(function(){immediatelyLoadSongTracks(s,t)},200);
    
}


var immediatelyLoadSongTracks = function(s,t){//now, actually load the files

var vocalsLoaded=false;
    

    if (manifest[s].children[t] && debugMainScreen===false){//make sure the entry exists.
     
     
     var trackToLoad=oggHTTPserver + manifest[s].children[t].path;      
     //console.log("let's try: " + trackToLoad);
     
     if (manifest[s].children[t].name.match(/bass/i) || manifest[s].children[t].name.match(/rhythm/i) ){//bass
        
      iType="bass";
      bass.push ( new Howl({
                  urls: [trackToLoad],
                  autoplay: false,
                  loop: false,
                  volume: startVol,
                  onload: function() {
                    loadSongTracks(s,t+1);
                  }}));
  
  
  //   }else if (manifest[s].children[t].name.match(/guitar/i) || manifest[s].children[t].name.match(/keys/i) || manifest[s].children[t].name.match(/piano/i) ){//guitars or keys
  //      iType="keysguitar";
     }else if (manifest[s].children[t].name.match(/vocal/i)){//vocal
          iType="vocal";
          
               if (!vocalsLoaded){//don't double-fire the next song
                   vocals.push ( new Howl({
                          urls: [trackToLoad],
                          autoplay: false,
                          loop: false,
                          volume: maxVol,
                          onload: function() {
                            loadSongTracks(s,t+1);
                          },
                          onend: function(){location.reload(true);}
    
                          }));
                   vocalsLoaded=true;
               }else{           
                
                                   vocals.push ( new Howl({
                          urls: [trackToLoad],
                          autoplay: false,
                          loop: false,
                          volume: maxVol,
                          onload: function() {
                            loadSongTracks(s,t+1);
                          }
                          }));
                }
                




     }else if (manifest[s].children[t].name.match(/song/i)){//sink
            if (foundVocal && foundSong){
                iType="sink";
                sink.push ( new Howl({
                              urls: [trackToLoad],
                              autoplay: false,
                              loop: false,
                              volume: startVol,
                              onload: function() {
                                loadSongTracks(s,t+1);
                              }}));


            }else{
               iType="vocal";    

               if (!vocalsLoaded){//don't double-fire the next song
                   vocals.push ( new Howl({
                          urls: [trackToLoad],
                          autoplay: false,
                          loop: false,
                          volume: maxVol,
                          onload: function() {
                            loadSongTracks(s,t+1);
                          },
                          onend: function(){location.reload();}
    
                          }));
                          vocalsLoaded=true;
               }else{           
                
                                   vocals.push ( new Howl({
                          urls: [trackToLoad],
                          autoplay: false,
                          loop: false,
                          volume: maxVol,
                          onload: function() {
                            loadSongTracks(s,t+1);
                          }
                          }));
                }
                
                
                
               
               
               
            }    
     }else if (manifest[s].children[t].name.match(/drum/i)){//drums
        iType="drum";
          drums.push ( new Howl({
                      urls: [trackToLoad],
                      autoplay: false,
                      loop: false,
                      volume: startVol,
                      onload: function() {
                        loadSongTracks(s,t+1);
                      }}));
        
        
     }else{ //everything else (player 3)
        iType="sink";
                  sink.push ( new Howl({
                      urls: [trackToLoad],
                      autoplay: false,
                      loop: false,
                      volume: startVol,
                      onload: function() {
                        loadSongTracks(s,t+1);
                      }}));

     }
     
     console.log("Loading: " + manifest[s].children[t].path  + " (" + iType +   ") " + (t +1) , "of "  + manifest[s].children.length);
     
     
 }else{
    
    console.log("All Tracks loaded. Playing.");
    
    setTimeout(function(){
        $("#titlescreen").css("display", "none");
        $("#forkme").css("display", "none");
        $("#thegame").css("display", "inline");
    },debugMainScreen ? 0 : 5000);
    $("#songtitle").html("PLAYING: " + currentSong );
    titleLoop.fade(titleLoop.volume(), 0,5000, function(){titleLoop.stop();})
    
    play();
    }
 
}  //end load songs function


function setTrackVol(instrument,vol){
if (instrument===0){
    drums.forEach(function(whichTrack){
       //console.log(whichTrack);
       whichTrack.volume(vol);
    });
}

if (instrument===1){
    bass.forEach(function(whichTrack){
       whichTrack.volume(vol);
    });
}

if (instrument===2){
    sink.forEach(function(whichTrack){
       whichTrack.volume(vol);
    });
}





}





var play = function() {
    vocals.forEach(function(whichTrack){
       whichTrack.play();
    });
    drums.forEach(function(whichTrack){
       whichTrack.play();
    });
    bass.forEach(function(whichTrack){
       whichTrack.play();
    });
    sink.forEach(function(whichTrack){
       whichTrack.play();
    });
};




















$( document ).ready(function() {
    console.log( "ready!" );










    $.ajax({
      dataType:'json',
      type: 'GET',
      url: oggHTTPserver + "manifest.JSON",
      success: function(data, textStatus, jqXHR) {
        // `data` contains parsed JSON
        manifest=data.children;
        console.log(manifest.length + " songs available");
        
        setTimeout(function(){
        titleLoop = new Howl({
            urls: ['BitQuestLoop.ogg'],
            autoplay: true,
            loop: true,
            volume: (debugMainScreen ? 0 : maxVol)
            }
        );
            },5000) //enough time to allow memory to be reclaimed? Maybe?

        setTimeout(function(){
        $("#presents").css("display", "none");
        $("#titlescreen").css("display", "inline");
        $("#forkme").css("display", "inline");
            },debugMainScreen ? 0 : 5000) //cancel KRC Presents and load main screen


        setTimeout(function(){loadRandomSong();},debugMainScreen ? 500 : 20000) //enough time to allow memory to be reclaimed


        ding = new Howl({
            urls: ['ding.ogg'],
            autoplay: true,
            loop: false,
            volume: maxVol
            }
        );

        





        
        
      },
      error: function(jqXHR, textStatus, errorThrown) {
         console.log("COULD NOT LOAD MANIFEST!");
      }
      
      
    });




}); //end document ready

socket.on('clientUpdate', function(data) { //client dancability info
	var gradient=0;
	var activeColor;
	var inactiveColor;
	//console.log(data);


    if (data.slot===0){
        activeColor="#FF5555";
        inactiveColor='#770000';
    }

    if (data.slot===1){
        activeColor="#55FF55";
        inactiveColor='007700';
    }
    
    if (data.slot===2){
        activeColor="#00AAAA";
        inactiveColor='007777';
    }
    
    if (data.buttonPushed){
        $( "#button"+data.slot).css("background-color", activeColor);
    }else{
        $( "#button"+data.slot).css("background-color", inactiveColor);
    }



    if (data.danceScore<danceScore){ gradient=250}else{gradient=0}
    
    //console.log(data.slot);
    if (data.slot<3){
        if (data.buttonPushed){
            setTrackVol(data.slot, data.danceScore/70)
        }else{
            setTrackVol(data.slot,0)            
        }   
        
    }
    
     
     var myScore = (data.danceScore * 1.5);
     if (myScore>100){myScore=100}
     $( "#bar" +data.slot).css("height", myScore + "%");
     $( "#bar" +data.slot).css("top",  100-myScore + "%");        
      
     
     
      danceScore =data.danceScore;
    
	
	
});




</script>