 <!DOCTYPE html>
<html>

<head><title>NOISEY.SPACE</title>
</head>


 <script type="text/javascript" src="jquery-2.1.4.js"></script>
 <script type="text/javascript" src="/socket.io/socket.io.js"></script>
 <script type="text/javascript" src="howler.js"></script>


    
<style>



@font-face {
    font-family: "Press Start 2P";
    src: url('PressStart2P.ttf') format('truetype');
}



body{background-color:#000000; font-family:"Press Start 2P"; font-size:1.5vw; color:#FFFFFF}

.noiselines{
width: 3vw;
visibility: hidden;
}

.instrumentwrapper{
    display: table; 
    height: 14vh;
    text-align:center;
    margin:auto;
}

.instrument{

     vertical-align: middle;
     display: table-cell;
     margin:auto;
} 


#songtitle{
    position:absolute;
    top:94vh;
    left:2.5vw;
}

#titlescreen{
    position:absolute;
    left:10vw;
    top:5vh;
    width:80vw;
    border:0px;
    padding:0px;
    display:none;
    text-align: center;
    }


#titleinstructions{
    position:absolute;
    bottom:5vh;
    left:10vw;
    width:80vw;
    border:0px;
    padding:0px;
    text-align: center;
    display:none;
}


#story{
    position:absolute;
    left:10vw;
    top:5vh;
    width:80vw;
    border:0px;
    padding:0px;
    display:none;
    text-align: center;

    }




#songprogress{
    position:absolute;
    width:57.5vw;
    height:3.5vh;
    border: 0.2em solid #FFFFFF;
    background-color:grey;
    padding: 0px;
    top:87vh;
    left:2.5vw;
}

   #progresscolor{
       background-color:#FF5555;
       width: 0%;
       height: 100%;
       padding:0px;
       position: relative;
       left: 0%;

    }










.centeredDiv{
  position:absolute;
  color:#fff;
  width:90%;
  top:50%;
  left:50%;
  /*background-color:red; */
  padding:0.6em;
  transform: translate(-50%,-50%);
   text-align: center;
} 



  #thegame{
    display:none
    }







.roundedbox{
    position: absolute; 
    text-align:center; 
    border-radius: 2em;
    border: 0.2em solid #FFFFFF;
    padding:0.8em; 
    width: 15vw;
    top:2.6vh;
    height: 62vh; 
    color:#FFFFFF;
    background-color:#222222;
}




  .metercontainer {
    margin:auto; 
    margin-top:2.6vh;
      background-color: white;
      padding: 0.2em;
      height: 42vh;
      width:6vw;
    }


  .meterbar {
      background-color: black;
      padding: 0px;
      height: 100%;
      width:100%;
    }
    
   .metercolorbar{
        width: 100%;
       height: 0%;
       padding:0px;
       position: relative;
       top: 100%;

    }


.console{
    position: absolute; 
    text-align:center; 
    border-radius: 2em;
    border: 0.2em solid #FFFFFF;
    padding: 0.8em; 
    width: 15vw;
    height: 5.3vh;
    top:73vh; 
    background-color:#222222;
}


#sidebar{
    position: fixed; 
    text-align:center; 
    border-radius: 2em;
    border: 0.2em solid #000000;
    padding: 0.8em; 
    width: 32vw;
    height:83.5vh;
    left:63.2vw; 
    top:2.6vh; 
    background-color:#000000;
}





 
 </style>




<body>

<div id="presents" class="centeredDiv">Karaoke Research Council Presents</div>

<img id="forkme" style="display:none; position: fixed; top: 0; right: 0; border: 0;" src="ForkMeOnGithub.png">

<div id="titlescreen">Karaoke Research Council Presents<br><br><br><br><br><br><br><img src="ns_logo.png" style="width:45%">
</div>

<div id="titleinstructions">
    <span style="color:grey;">connect to</span><br><br><br><span style="font-size:2vw">HTTP://NS.MOD.BZ </span><br><br><span style="color:grey;"><br>on your mobile browser to play. <br><br></span>
    <div id="loadupdates">&nbsp;</div>
</div>


<div id="story">    
    
    <img src="ns_logo.png" style="width:15%"><br><br>
    
    <div style="margin-top:2em">The band wants to play, but nobody's dancing!</div>
    <br>
    Can you help them?
    <br><br><br>
    <img src="theband.png">
    <br>

</div>


<div id="thegame">



    
    <div id="box1" class="roundedbox" style="left:2.5%;">PLAYER 1
        <div class="metercontainer">
            <div class="meterbar"><div class="metercolorbar" id="bar0" style="background-color: #FF0000;"></div></div>
        </div>
           <div class="instrumentwrapper"><div class="instrument"><span style="float:left; width:3vw"><img id="noise1left" src="blacknoiselinesleft.gif" class="noiselines"></span><span style="float:left"><img id="instrument1" src="drums.png" style="width:8vw"></span><span style="float:left; width:3vw"><img id="noise1right" src="blacknoiselinesright.gif" class="noiselines"></span> </div></div>
    </div>
    
    
    
    <div id="box2" class="roundedbox" style="left:22.5%;">PLAYER 2
        <div class="metercontainer">
            <div class="meterbar"><div class="metercolorbar" id="bar1" style="background-color: #00FF00;"></div></div>
        </div>
        <div class="instrumentwrapper"><div class="instrument"><span style="float:left; width:3vw"><img id="noise2left" src="blacknoiselinesleft.gif" class="noiselines"></span><span style="float:left"><img id="instrument2" src="bass.png" style="width:6vw"></span><span style="float:left; width:3vw"><img id="noise2right" src="blacknoiselinesright.gif" class="noiselines"></span> </div></div>
    </div>
    
    
    <div id="box3" class="roundedbox" style="left:42.5%;">PLAYER 3
        <div class="metercontainer">
            <div class="meterbar"><div class="metercolorbar" id="bar2" style="background-color: #0000FF;"></div></div>
        </div>
        <div class="instrumentwrapper"><div class="instrument"><span style="float:left; width:3vw"><img id="noise3left" src="blacknoiselinesleft.gif" class="noiselines"></span><span style="float:left"><img id="instrument3" src="sink.png" style="width:8vw"></span><span style="float:left; width:3vw"><img id="noise3right" src="blacknoiselinesright.gif" class="noiselines"></span> </div></div>
    </div>
    
    <div id="console1" class="console" style="left:2.5%;">VISIT URL TO JOIN!</div>
    <div id="console2" class="console" style="left:22.5%;">VISIT URL TO JOIN!</div>
    <div id="console3" class="console" style="left:42.5%;">VISIT URL TO JOIN!</div>
    
    
    <div id="songprogress"><div id="progresscolor"></div></div>
    
    
    <div id="songtitle">&nbsp;</div>
    
    <div id="sidebar"><img id="ns_sidebar" src="ns_condensed.png" style="width:100%">
     <div style="position:absolute; top:30vh; width:100%; margin-top:1em; color:grey">Connect to:
         <div style="width:100%; margin-top:2em"><span style="font-size:2.3em">NS.BOX.BZ</span></div>
         <div style="width:100%; margin-top:0.75em; color:grey">or</div>
         <div style="width:100%; margin-top:0.75em; color:white">http://nois<span style="color:#FF5555">e</span>y.space</div>
         <div style="width:100%; margin-top:2em; color:grey">...on your mobile browser to play.</div>
         <div style="width:100%; margin-top:3em"><span style="font-size:1.5em; color:#FF5555">PUSH THE BUTTON AND DANCE!</span></div>
     </div>
    </div>


</div>

<div id="credits" style="display:none; margin:0px; position:absolute; width:95vw; text-align:center;">CREDITS<br><br><br><br><img src="ns_logo.png" style="width:15%"><br><br>
<br><br>
&copy;2016 Ross Brackett
<br><br>A product of the Karaoke Research Council
<br><br><br>
<div style="font-size:0.5em">
<br><br>Fork me at: github.com/karaokeresearch/noisey.space
<br><br><br><br>This software is distributed under the GPL v3.0 license
<br>Full text: http://www.gnu.org/licenses/gpl-3.0.txt
<br>
<br><br><br>Additional audio assets utilized by this project:
<br>
<br>"cf_FX_batch_jingle_glock_N--kloing.aif" by cfork 
<br>(referenced in this project as ding.ogg)
<br>https://www.freesound.org/people/cfork/sounds/26875/
<br>Licensed under Creative Commons: By Attribution 3.0 License
<br>http://creativecommons.org/licenses/by/3.0/
<br><br>
<br>"Bit Quest" Kevin MacLeod (incompetech.com)
<br>Licensed under Creative Commons: By Attribution 3.0 License
<br>http://creativecommons.org/licenses/by/3.0/
<br><br><br>A complete list of software utilized by this project
<br>and their respetive licenses is present in the licenses 
<br>directory of this project.
</div>
<br><br>THE END
</div>



</body>




</html>

<script>
var debugMainScreen=false;  //change this to true if you need to work on the main title screen.


var socket = io('/display');
var manifest;
var vocals=[];
var drums=[];
var bass=[];
var sink=[];
var oggHTTPserver='http://localhost:8080/';
var foundVocal=false;
var foundSong=false;
var titleLoop;

var startVol=0;
var maxVol=0.75;
var currentSong;
var nsLogoBig; //animation in case you achieve noisey.space

var slot=[];
slot[0]={};
slot[1]={};
slot[2]={};


var loadRandomSong= function(){

 vocals=[];
 drums=[]; 
 bass=[];  
 sink=[];  
 foundVocal=false;
 foundSong=false;



 
 var iType;
 var s=Math.floor(Math.random() * manifest.length);

 
 
 
 console.log("Found:   " + manifest[s].name);
 
 currentSong=manifest[s].name;
 $("#loadupdates").html("LOADING: <span style=\"color:yellow\">" + currentSong + "</span>");
 

  for (t in manifest[s].children){  //once through to see if "vocal" and "song" are different.
     
     if (manifest[s].children[t].name.match(/vocal/i)){//found "vocal.ogg"
        foundVocal=true;
     }
    if (manifest[s].children[t].name.match(/song/i)){//found "song.ogg"
        foundSong=true;
     }
 }   

loadSongTracks(s,0); //start with track 0
 
 
    
}



var loadSongTracks = function(s,t){
console.log ("waiting 200 ms")
setTimeout(function(){immediatelyLoadSongTracks(s,t)},200);
    
}


var immediatelyLoadSongTracks = function(s,t){//now, actually load the files

var vocalsLoaded=false;
    

    if (manifest[s].children[t] && debugMainScreen===false){//make sure the entry exists.
     
     
     var trackToLoad=oggHTTPserver + manifest[s].children[t].path;      
     //console.log("let's try: " + trackToLoad);
     
     if (manifest[s].children[t].name.match(/bass/i) || manifest[s].children[t].name.match(/rhythm/i) ){//bass
        
      iType="bass";
      bass.push ( new Howl({
                  urls: [trackToLoad],
                  autoplay: false,
                  loop: false,
                  volume: startVol,
                  onload: function() {
                    loadSongTracks(s,t+1);
                  }}));
  
  
  //   }else if (manifest[s].children[t].name.match(/guitar/i) || manifest[s].children[t].name.match(/keys/i) || manifest[s].children[t].name.match(/piano/i) ){//guitars or keys
  //      iType="keysguitar";
     }else if (manifest[s].children[t].name.match(/vocal/i)){//vocal
          iType="vocal";
          
               if (!vocalsLoaded){//don't double-fire the next song
                   vocals.push ( new Howl({
                          urls: [trackToLoad],
                          autoplay: false,
                          loop: false,
                          volume: maxVol,
                          onload: function() {
                            loadSongTracks(s,t+1);
                          },
                          onend: rollCredits
    
                          }));
                   vocalsLoaded=true;
               }else{           
                
                                   vocals.push ( new Howl({
                          urls: [trackToLoad],
                          autoplay: false,
                          loop: false,
                          volume: maxVol,
                          onload: function() {
                            loadSongTracks(s,t+1);
                          }
                          }));
                }
                




     }else if (manifest[s].children[t].name.match(/song/i)){//sink
            if (foundVocal && foundSong){
                iType="sink";
                sink.push ( new Howl({
                              urls: [trackToLoad],
                              autoplay: false,
                              loop: false,
                              volume: startVol,
                              onload: function() {
                                loadSongTracks(s,t+1);
                              }}));


            }else{
               iType="vocal";    

               if (!vocalsLoaded){//don't double-fire the next song
                   vocals.push ( new Howl({
                          urls: [trackToLoad],
                          autoplay: false,
                          loop: false,
                          volume: maxVol,
                          onload: function() {
                            loadSongTracks(s,t+1);
                          },
                          onend:rollCredits
    
                          }));
                          vocalsLoaded=true;
               }else{           
                
                                   vocals.push ( new Howl({
                          urls: [trackToLoad],
                          autoplay: false,
                          loop: false,
                          volume: maxVol,
                          onload: function() {
                            loadSongTracks(s,t+1);
                          }
                          }));
                }
                
                
                
               
               
               
            }    
     }else if (manifest[s].children[t].name.match(/drum/i)){//drums
        iType="drum";
          drums.push ( new Howl({
                      urls: [trackToLoad],
                      autoplay: false,
                      loop: false,
                      volume: startVol,
                      onload: function() {
                        loadSongTracks(s,t+1);
                      }}));
        
        
     }else{ //everything else (player 3)
        iType="sink";
                  sink.push ( new Howl({
                      urls: [trackToLoad],
                      autoplay: false,
                      loop: false,
                      volume: startVol,
                      onload: function() {
                        loadSongTracks(s,t+1);
                      }}));

     }
     
     console.log("Loading: " + manifest[s].children[t].path  + " (" + iType +   ") " + (t +1) , "of "  + manifest[s].children.length);
     
     
 }else{
    
    console.log("All Tracks loaded. Playing."); //begin the game!
    
    setTimeout(function(){
        $("#story").css("display", "none");
        $("#thegame").css("display", "inline");
        $("#titleinstructions").css("display", "none");
        $("#story").css("display", "none");
    },debugMainScreen ? 0 : 2500);
    $("#songtitle").html("PLAYING: <span style=\"color:yellow\">" + currentSong + "</span>" );
    titleLoop.fade(titleLoop.volume(), 0,5000, function(){titleLoop.stop();})
    
    

    
    
    
    
    
    play();
    }
 
}  //end load songs function


var setTrackVol = function(instrument,vol){
    if (instrument===0){
        drums.forEach(function(whichTrack){
           //console.log(whichTrack);
           whichTrack.volume(vol);
        });
    }
    
    if (instrument===1){
        bass.forEach(function(whichTrack){
           whichTrack.volume(vol);
        });
    }
    
    if (instrument===2){
        sink.forEach(function(whichTrack){
           whichTrack.volume(vol);
        });
    }
    
}



var rollCredits = function(){
$("#thegame").css("display", "none");
$("#credits").css("display", "inline");
    setTimeout(function(){
        location.reload(true);
        },3000)
};    





var play = function() {
    vocals.forEach(function(whichTrack){
       whichTrack.play();
    });
    drums.forEach(function(whichTrack){
       whichTrack.play();
    });
    bass.forEach(function(whichTrack){
       whichTrack.play();
    });
    sink.forEach(function(whichTrack){
       whichTrack.play();
    });

    setInterval(function(){ //start the progress bar moving.
    $("#progresscolor").css("width", ((vocals[0].pos()/vocals[0]._duration)*100) + "%");
    }, 1000);
    
  
    
    
    

};





$( document ).ready(function() {
    console.log( "ready!" );


    $.ajax({
      dataType:'json',
      type: 'GET',
      url: oggHTTPserver + "manifest.JSON",
      success: function(data, textStatus, jqXHR) {
        // `data` contains parsed JSON
        manifest=data.children;
        console.log(manifest.length + " songs available");
        
        setTimeout(function(){
            titleLoop = new Howl({
                urls: ['BitQuestLoop.ogg'],
                autoplay: true,
                loop: true,
                volume: (debugMainScreen ? 0 : maxVol)
                }
            );
        },2500) //enough time to allow memory to be reclaimed? Maybe?

        setTimeout(function(){
        $("#presents").css("display", "none");
        $("#titlescreen").css("display", "inline");
        $("#titleinstructions").css("display", "inline");
        $("#forkme").css("display", "inline");
            },debugMainScreen ? 0 : 2500) //cancel KRC Presents and load title screen

        setTimeout(function(){
        $("#titlescreen").css("display", "none");
        $("#forkme").css("display", "none");
        
            },debugMainScreen ? 500 : 9500) //disappear title screen

        setTimeout(function(){
        $("#story").css("display", "inline");        
            },debugMainScreen ? 500 : 10500) //appear story screen 1 sec later
            
            
        setTimeout(function(){loadRandomSong();},debugMainScreen ? 500 : 18000) //enough time to allow memory to be reclaimed?

        ding = new Howl({
            urls: ['ding.ogg'],
            autoplay: true,
            loop: false,
            volume: maxVol
            }
        );
        
        
      },
      error: function(jqXHR, textStatus, errorThrown) {
         console.log("COULD NOT LOAD MANIFEST!");
      }
      
      
    });



    setInterval(function(){ //instrument animations if at 100%
        for (var i=0; i<3; i++){
            if (slot[i].danceScore>15 && slot[i].buttonPushed===true){
            $("#noise" + (i+1) + "right").css("visibility", "visible");
            $("#noise" + (i+1) + "left").css("visibility", "visible");
            }
            else{
            $("#noise" + (i+1) + "right").css("visibility", "hidden");
            $("#noise" + (i+1) + "left").css("visibility", "hidden");
            }
        }
            
        if (slot[0].danceScore>15 && slot[0].buttonPushed===true  &&  slot[1].danceScore>15 && slot[1].buttonPushed===true  &&  slot[2].danceScore>15 && slot[2].buttonPushed===true){

            if (nsLogoBig===true){
                $("#ns_sidebar").css("width", "80%");
                nsLogoBig=false;
            }else{
                $("#ns_sidebar").css("width", "100%");
                nsLogoBig=true;
            }

            
        }            
        
    },250);








}); //end document ready




socket.on('command', function(data) { //client dancability info

    if (data.command==="secondsLeft"){
    $("#console"+(data.slot+1)).html("PUSH THE BUTTON!  " + data.parameter);
        }
    else if (data.command==="assignSlot"){
        $( "#box"+(data.slot+1)).css("background-color", "#AAAAAA");
        $( "#box"+(data.slot+1)).css("color", "#000000");
        $( "#console"+(data.slot+1)).css("background-color", "#AAAAAA");
        $( "#console"+(data.slot+1)).css("color", "#000000");

        
        
    }
    else if (data.command==="disconnected"){
            $("#console"+(data.slot+1)).html("VISIT URL TO JOIN!");
            $("#box"+(data.slot+1)).css("background-color", "#222222");
            $("#box"+(data.slot+1)).css("color", "#FFFFFF");
            $("#console"+(data.slot+1)).css("background-color", "#222222");
            $("#console"+(data.slot+1)).css("color", "#FFFFFF");

    }
	
	
});



socket.on('clientDance', function(data) { //client dancability info
	var activeColor;
	var inactiveColor;

if (data.slot<3){
 
     if (data.danceScore>10 && data.buttonPushed===false){$("#console"+(data.slot+1)).html("PUSH THE BUTTON!");}
     if (data.danceScore<10 && data.buttonPushed===true){$("#console"+(data.slot+1)).html("NOW DANCE!");}
     if (data.danceScore>10 && data.buttonPushed===true){$("#console"+(data.slot+1)).html("KEEP DANCING!");}
    
    
    $( "#console"+(data.slot+1)).css("color", "#000000"); //inelegant. Display screen doesn't get info about current sessions during handshake.
    $( "#box"+(data.slot+1)).css("color", "#000000");     //

    if (data.slot===0){
        activeColor="#FF5555";
        inactiveColor='#AAAAAA';
    }

    if (data.slot===1){
        activeColor="#99FF99";
        inactiveColor='#AAAAAA';
    }
    
    if (data.slot===2){
        activeColor="#588fff";
        inactiveColor='#AAAAAA';
    }
    
    if (data.buttonPushed){
        
        $( "#console"+(data.slot+1)).css("background-color", activeColor);
        $( "#box"+(data.slot+1)).css("background-color", activeColor);
    }else{
        $( "#console"+(data.slot+1)).css("background-color", inactiveColor);
        $( "#box"+(data.slot+1)).css("background-color", inactiveColor);
    }

      

    if (data.buttonPushed){
        setTrackVol(data.slot, data.danceScore/70)
    }else{
        setTrackVol(data.slot,0)            
    }   
     
     slot[data.slot].danceScore=data.danceScore;
     slot[data.slot].buttonPushed=data.buttonPushed;
    
        
    
    
     
     var myScore = (data.danceScore * 1.5);
     if (myScore>100){myScore=100}
     $( "#bar" +data.slot).css("height", myScore + "%");
     $( "#bar" +data.slot).css("top",  100-myScore + "%");        
      
     
  } 
      
    
	
	
});




</script>