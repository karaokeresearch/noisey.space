<html>
	<head>
		<meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1, maximum-scale=1">
		<title>noisey.space</title>
	</head>


	
		<script type="text/javascript" src="gyro.js"></script>
		<script type="text/javascript" src="/socket.io/socket.io.js"></script>
        <script type="text/javascript" src="jquery-2.1.4.js"></script>
        <script type="text/javascript" src="cookies.js"></script>		
        <script type="text/javascript" src="hammer-time.js"></script>	
        
        
<style>
			
</style>



<body bgcolor="#000000" style="padding: 0; margin: 0;">


    <div style="position: absolute; left: 0px; top: 0px; background-color:#222222; color: white; font-family:Sans; font-size:6vw; height:10vw; width:10vw;" id="slot"></div>
<div style="background-color:black; height:100%; width:100%; touch-action: none;" id="wholepage">
    <div style="position: absolute; right: 25vw; top: 25vw; background-color:grey; height:50vw; width:50vw;" id="thebutton"></div>
    <div style="position: absolute; right: 0px; top: 100vw; background-color:black; color: white; font-family:Sans; height:50vw; width:100vw;" id="console"></div>                                                                                                                                   

    
</div>
</body>


	<script type="text/javascript">
		var socket = io('/client');
		
		
		
		
		var averageMotion=15;
		var doingit=false;
        var xyzArray=[];
	    xyzArray[0]=[];
        xyzArray[1]=[];    
        xyzArray[2]=[];
        
        
        var danceScore=0;
        var publishDate=0;
        var xyzMin=[];
        var xyzMax=[];
        var ticksSincePublish=0;
        var deviceID;
        var buttonPushed=false;
        var justFullScreened=false;        
        var assignedSlot=-1;
        var fingersDown=0; //prevent double-tap
        
        var inactiveColor = "grey";
        var activeColor = "white";

        
        var downHappened=0;
        var upHappened=0;


$(document).ready(function () { //

$('#wholepage').bind('touchstart', function(e){
    fingersDown++;
    //downHappened++;
   //$("#slot").html(downHappened + " " + upHappened);
if (fingersDown===1){
    buttonPushed=true;
    sendDanceStatus();    
    $("#thebutton").css("background-color", activeColor);
    $("#console").html("NOW DANCE!");

   if (justFullScreened===true){ //the second time you push the button it locks orientation in case you didn't get it the first time.
        lockOrientation();
        justFullScreened=false;
        console.log("locking orientation a second time in case it got missed the first time");
    }

   if (!(document.fullScreen || document.mozFullScreen || document.webkitIsFullScreen)){
        fullscreen();
        justFullScreened=true;
        setTimeout(function(){
            lockOrientation();
        },1); //you've got to be kidding me. This fixes Firefox orientation lock #oratleastitusedto #haxx #findabetterway
        console.log ("fullscreening and attempting to lock orientation")
   }
 navigator.vibrate(100);
}
 
 
})                                      

$('#wholepage').bind('touchend', function(e){
    fingersDown--;
    //upHappened++;
    //$("#slot").html(downHappened + " " + upHappened);
if (fingersDown===0){    
    buttonPushed=false;
    sendDanceStatus();    
    $("#thebutton").css("background-color", inactiveColor);
    navigator.vibrate(100);
}
})                                      




    if (!Cookies('deviceID')){
        deviceID = 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {              //generate a UUID to be used as a session ID
            var r = crypto.getRandomValues(new Uint8Array(1))[0]%16|0, v = c == 'x' ? r : (r&0x3|0x8);
            return v.toString(16);
        });
        Cookies.set('deviceID', deviceID, { expires: '01/01/2030' })
    } else{deviceID=Cookies('deviceID')}


        sendDeviceID();
        console.log("ready");
        gyro.frequency=50;



        gyro.startTracking(function(o) {


            if (o.x && o.y && o.z){ //return undef until the API comes online
                xyzArray[0].push(o.x);
                if (xyzArray[0].length>20){xyzArray[0].shift();}
                xyzArray[1].push(o.y);
                if (xyzArray[1].length>20){xyzArray[1].shift();}
                xyzArray[2].push(o.z);
                if (xyzArray[2].length>20){xyzArray[2].shift();}
    
                for (var i=0; i<3; i++){
                    xyzMin[i]= xyzArray[i][0];
                    xyzMax[i]= xyzArray[i][0];
                    for (var j=1; j<xyzArray[i].length; j++) {
                        if (xyzArray[i][j]<xyzMin[i]) {xyzMin[i]=xyzArray[i][j]};
                        if (xyzArray[i][j]>xyzMax[i]) {xyzMax[i]=xyzArray[i][j]};
                    }
                }
                danceScore = ( Math.abs(xyzMin[0] - xyzMax[0]) +    Math.abs(xyzMin[1] - xyzMax[1])+   Math.abs(xyzMin[2] - xyzMax[2]));
            }
            
            //if (xyzArray[0].length>19){
            //    if (o.z){danceScore = ( Math.abs(xyzMin[0] - xyzMax[0]) +    Math.abs(xyzMin[1] - xyzMax[1])+   Math.abs(xyzMin[2] - xyzMax[2]));}
            //}else{danceScore=0;}
            //$("#slot").html(danceScore);
            //$("#console").html(Math.abs(xyzMin[0] - xyzMax[0])    + "<br>" + Math.abs(xyzMin[1] - xyzMax[1])    + "<br>" + Math.abs(xyzMin[2] - xyzMax[2])    + "<br>" +  danceScore  + "<br>" +publishDate );

            ticksSincePublish++;
            //console.log(ticksSincePublish);
            if (ticksSincePublish>=5){ //every quarter second
                sendDanceStatus();
                ticksSincePublish=0;
            }


        });




}); //end document ready




socket.on('command', function(data) { //incoming server instructions
          console.log("command:");
          console.log(data.command, data.parameter);
          if (data.command==="disconnected"){
            $("#console").html("WAITING YOUR TURN...");
            $("#slot").html('');
            activeColor="white";
            inactiveColor="grey"
            
            sendDeviceID();
            assignedSlot=-1;
            }

          if (data.command==="assignSlot"){
            $("#slot").html(data.parameter+1);
            assignedSlot=data.parameter;
            if (assignedSlot===0){
                activeColor="#FF5555";
                inactiveColor='#AA0000';
            }

            if (assignedSlot===1){
                activeColor="#55FF55";
                inactiveColor='00AA00';
            }
            
            if (assignedSlot===2){
                activeColor="#00AAAA";
                inactiveColor='009999';
            }

            $("#thebutton").css("background-color", inactiveColor);



            }

          if (data.command==="secondsLeft"){
            $("#console").html("START DANCING OR HOLD THE BUTTON!<BR>HURRY! " + data.parameter + " SECONDS LEFT!");
            //navigator.vibrate(100); //add back in before production
            assignedSlot=data.parameter;
            }


          

          
});



socket.on('authRequest', function(data) { //failsafe in case authorization fails or server is restarted. Server can request your stored cookie deviceID
          sendDeviceID();
});

var sendDanceStatus = function(){
    socket.emit('danceStatus', {
        buttonPushed: buttonPushed,
        danceScore: Math.round(danceScore*100)/100, //two digit hack
    });
    
    if (danceScore>10 && buttonPushed===true){$("#console").html("YEAH!!!! KEEP DANCING AND HOLDING THAT BUTTON!!!!");}
    if (danceScore>10 && buttonPushed===false){$("#console").html("YEAH!!!! KEEP DANCING! HOLD THE BUTTON TO MAKE NOISE!!!!");}
    if (danceScore<10 && buttonPushed===true){$("#console").html("NOW START DANCING TO MAKE NOISE");}
    
    
};

var sendDeviceID = function(){
    console.log("registering", deviceID);
    if(deviceID){
      socket.emit('register', {
                deviceID: deviceID
      });
     }
};           






var lockOrientation= function() {
    if (typeof screen.orientation !== "undefined" && screen.orientation.lock !== "undefined" ){
        screen.orientation.lock('portrait-primary');
    } else if(window.screen.lockOrientation){
        window.screen.lockOrientation('portrait-primary');
    } else if(window.screen.mozLockOrientation){
        window.screen.mozLockOrientation('portrait-primary');
    } else if (window.screen.msLockOrientation){
        window.screen.msLockOrientation('portrait-primary');
    }
};


var fullscreen = function(callback) {
    if(document.documentElement.requestFullscreen) {
        document.documentElement.requestFullscreen();
    } else if(document.documentElement.webkitRequestFullscreen) {
        document.documentElement.webkitRequestFullscreen();
    } else if(document.documentElement.mozRequestFullScreen) {
        document.documentElement.mozRequestFullScreen();
    } else if(document.documentElement.msRequestFullscreen) {
        document.documentElement.msRequestFullscreen();
    }
};



		</script>
</html>
